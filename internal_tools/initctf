#!/usr/bin/env python3

import os
import sys
import re
import subprocess
import time
import tempfile
import shutil
import requests
from bs4 import BeautifulSoup
import datetime

if __name__ == '__main__':
  event_url = sys.argv[1]
  event_id = re.search('ctftime\.org/event/(\d+)', event_url).group(1)

  # request the ctf event page
  r = requests.get(sys.argv[1],
                   allow_redirects=True,
                   headers = {
                    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36'
                    })
  soup = BeautifulSoup(r.content, 'html.parser')
  for link in soup.find_all('a'):
    if not link.get('href'):
      continue

    m = re.fullmatch('/ctf/(\d+)', link.get('href'))
    if m:
      ctf_id = m.group(1)
      ctf_name = ''.join([t[0].upper() + t[1:] for t in link.text.strip().split() if t.lower() != 'ctf'])
      break

  ctf_name = ctf_name.replace('Preliminary', '').strip()
  full_name = '%s/%d' % (ctf_name, datetime.date.today().year)
  title = soup.find_all('title')[0].text.lower()
  if 'teaser' in title or 'qualifier' in title or 'quals' in title or 'preliminary' in title or 'prequal' in title:
    full_name += '/Quals'

  os.system('mkdir -p %s' % full_name)
  for category in ['crypto', 'web', 'pwn', 'rev', 'misc']:
    os.system('mkdir %s/%s' % (full_name, category))

  open('%s/README.md' % ctf_name, 'w').write('[CTFtime Page](https://ctftime.org/ctf/%s)\n' % ctf_id)
  open('%s/README.md' % full_name, 'w').write('[CTFtime Page](https://ctftime.org/event/%s)\n' % event_id)

  print(full_name)
